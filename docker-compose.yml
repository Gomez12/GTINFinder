services:
  postgresql:
    image: postgres:15
    container_name: gtin-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    networks:
      - gtin-finder-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  directus:
    image: directus/directus:11.13.4
    container_name: gtin-directus
    environment:
      KEY: ${DIRECTUS_KEY}
      SECRET: ${DIRECTUS_SECRET}
      DB_CLIENT: 'pg'
      DB_HOST: 'postgresql'
      DB_PORT: 5432
      DB_DATABASE: ${DIRECTUS_DB}
      DB_USER: ${DIRECTUS_USER}
      DB_PASSWORD: ${DIRECTUS_PASSWORD}
      PUBLIC_URL: 'http://localhost:8055'
      CORS_ORIGIN: 'http://localhost:3000'
      WEBSOCKETS_ENABLED: 'true'
    ports:
      - "8055:8055"
    networks:
      - gtin-finder-network
    depends_on:
      postgresql:
        condition: service_healthy
    volumes:
      - directus_uploads:/directus/uploads
      - directus_extensions:/directus/extensions
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8055/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  airflow:
    image: apache/airflow:3.1.3
    container_name: gtin-airflow
    environment:
      AIRFLOW__CORE__EXECUTOR: 'LocalExecutor'
      AIRFLOW__CORE__SQL_ALCHEMY_CONN: 'postgresql+psycopg2://${AIRFLOW_USER}:${AIRFLOW_PASSWORD}@postgresql:5432/${AIRFLOW_DB}'
      AIRFLOW__CORE__FERNET_KEY: ${AIRFLOW_FERNET_KEY}
      AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: 'true'
      AIRFLOW__CORE__LOAD_EXAMPLES: 'false'
      AIRFLOW__WEBSERVER__RBAC: 'true'
      AIRFLOW__WEBSERVER__EXPOSE_CONFIG: 'true'
      AIRFLOW__API__AUTH_BACKEND: 'airflow.api.auth.backend.basic_auth'
      AIRFLOW__CELERY__BROKER_URL: 'redis://redis:6379/0'
      AIRFLOW__CELERY__RESULT_BACKEND: 'redis://redis:6379/0'
      AIRFLOW__CORE__ENABLE_XCOM_PICKLING: 'true'
      _AIRFLOW_DB_UPGRADE: 'true'
      _AIRFLOW_WWW_USER_CREATE: 'true'
      _AIRFLOW_WWW_USER_USERNAME: ${AIRFLOW_USER}
      _AIRFLOW_WWW_USER_PASSWORD: ${AIRFLOW_PASSWORD}
    ports:
      - "8080:8080"
    networks:
      - gtin-finder-network
    depends_on:
      redis:
        condition: service_healthy
      postgresql:
        condition: service_healthy
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - airflow_logs:/opt/airflow/logs
    command: >
      bash -c "
        airflow db upgrade &&
        airflow users create -r Admin -u ${AIRFLOW_USER} -e admin@example.com -f Admin -l User -p ${AIRFLOW_PASSWORD} ||
        true &&
        airflow scheduler &
        exec airflow webserver
      "
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  authentik-server:
     image: ghcr.io/goauthentik/server:2024.8.2
     container_name: gtin-authentik-server
     command: server
     environment:
       AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY}
       AUTHENTIK_POSTGRESQL__HOST: 'postgresql'
       AUTHENTIK_POSTGRESQL__NAME: ${AUTHENTIK_DB}
       AUTHENTIK_POSTGRESQL__USER: ${AUTHENTIK_USER}
       AUTHENTIK_POSTGRESQL__PASSWORD: ${AUTHENTIK_PASSWORD}
       AUTHENTIK_ERROR_REPORTING__ENABLED: 'false'
       AUTHENTIK_EMAIL__HOST: 'localhost'
       AUTHENTIK_EMAIL__PORT: 1025
       AUTHENTIK_REDIS__HOST: redis
       AUTHENTIK_REDIS__PORT: 6379
       AUTHENTIK_REDIS__DB: 0
     ports:
       - "9000:9000"
       - "9443:9443"
     networks:
       - gtin-finder-network
     depends_on:
       redis:
         condition: service_healthy
       postgresql:
         condition: service_healthy
     volumes:
       - authentik_media:/media
       - authentik_templates:/templates
     healthcheck:
       test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9000/-/health/ready/ || exit 1"]
       interval: 30s
       timeout: 10s
       retries: 3
       start_period: 120s

  authentik-worker:
     image: ghcr.io/goauthentik/server:2024.8.2
     container_name: gtin-authentik-worker
     command: worker
     environment:
       AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY}
       AUTHENTIK_POSTGRESQL__HOST: 'postgresql'
       AUTHENTIK_POSTGRESQL__NAME: ${AUTHENTIK_DB}
       AUTHENTIK_POSTGRESQL__USER: ${AUTHENTIK_USER}
       AUTHENTIK_POSTGRESQL__PASSWORD: ${AUTHENTIK_PASSWORD}
       AUTHENTIK_ERROR_REPORTING__ENABLED: 'false'
       AUTHENTIK_EMAIL__HOST: 'localhost'
       AUTHENTIK_EMAIL__PORT: 1025
       AUTHENTIK_REDIS__HOST: redis
       AUTHENTIK_REDIS__PORT: 6379
       AUTHENTIK_REDIS__DB: 0
     networks:
       - gtin-finder-network
     depends_on:
       redis:
         condition: service_healthy
       postgresql:
         condition: service_healthy
     volumes:
       - authentik_media:/media
       - authentik_templates:/templates

  redis:
    image: redis:7-alpine
    container_name: gtin-redis
    ports:
      - "6379:6379"
    networks:
      - gtin-finder-network
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  nginx:
     image: nginx:alpine
     container_name: gtin-nginx
     ports:
       - "80:80"
       - "443:443"
     networks:
       - gtin-finder-network
     depends_on:
       - directus
       - airflow
       - authentik-server
     volumes:
       - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
       - ./nginx/conf.d:/etc/nginx/conf.d:ro
     healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:
    driver: local
  directus_uploads:
    driver: local
  directus_extensions:
    driver: local
  airflow_logs:
    driver: local
  authentik_media:
    driver: local
  authentik_templates:
    driver: local
  redis_data:
    driver: local

networks:
  gtin-finder-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
